<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Eleitoral V5</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --bg: #0f1115; --panel: rgba(20,24,30,0.95); --accent: #3b82f6; --text: #f3f4f6; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        #app { width: 100vw; height: 100vh; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; background: var(--bg); }

        .sidebar {
            position: absolute; top: 20px; left: 20px; width: 360px; bottom: 20px;
            background: var(--panel); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; z-index: 1000;
            display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .controls { padding: 15px; display: grid; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        select, .btn-primary { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; border-radius: 6px; cursor: pointer; }
        .btn-primary { background: var(--accent); border: none; font-weight: bold; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .cand-row { padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; }
        .cand-row:hover { background: rgba(255,255,255,0.02); }
        .cand-info { flex: 1; }
        .cand-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; }
        .cand-sub { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 4px; }
        .prog-bar { height: 4px; background: #333; margin-top: 6px; border-radius: 2px; }
        .prog-fill { height: 100%; transition: width 0.5s; }

        .legend { position: absolute; bottom: 25px; right: 25px; background: var(--panel); padding: 15px; border-radius: 8px; z-index: 999; width: 180px; font-size: 0.75rem; border: 1px solid #333; }
        .grad-bar { height: 10px; background: linear-gradient(90deg, #222, #fff); margin: 5px 0; border: 1px solid #444; }
        
        #loader { position: absolute; inset: 0; background: #0b0f19; z-index: 2000; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; flex-direction: column; }
        .hidden { opacity: 0; pointer-events: none; }
        
        .back-btn { position: absolute; top: 25px; left: 400px; z-index: 1000; background: var(--panel); color: #fff; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: none; }
        
        /* Tooltip Customizado */
        .leaflet-tooltip-own { background: rgba(15,23,42,0.95); border: 1px solid #444; color: #fff; border-radius: 6px; padding: 0; }
        .tt-head { padding: 8px 12px; border-bottom: 1px solid #444; font-weight: bold; font-size: 0.85rem; background: rgba(255,255,255,0.05); }
        .tt-body { padding: 8px 12px; }
        .tt-row { display: flex; justify-content: space-between; gap: 15px; font-size: 0.8rem; margin-bottom: 4px; color: #ccc; }
    </style>
</head>
<body>

<div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top:10px">Carregando...</p></div>

<div id="app">
    <button class="back-btn" id="backBtn" onclick="resetMap()">Voltar ao Brasil</button>

    <aside class="sidebar">
        <div class="header">
            <h1 style="margin:0; font-size:1.2rem;">üó≥Ô∏è Elei√ß√µes Brasil</h1>
            <small style="color:#888">Visualiza√ß√£o Oficial</small>
        </div>
        <div class="controls">
            <div style="display:flex; gap:5px;">
                <select id="yearSelect"></select>
                <select id="turnSelect">
                    <option value="1">1¬∫ Turno</option>
                    <option value="2">2¬∫ Turno</option>
                </select>
            </div>
            <select id="roleSelect">
                <option value="president">Presidente</option>
                <option value="governor">Governador</option>
                <option value="senator">Senador</option>
            </select>
            <button class="btn-primary" onclick="loadData()">ATUALIZAR DADOS</button>
        </div>
        <div class="list-container" id="candList">
            <div style="padding:40px; text-align:center; color:#555">Selecione filtros e clique em Atualizar.</div>
        </div>
    </aside>

    <main id="map"></main>

    <div class="legend">
        <b>Intensidade do Voto</b>
        <div class="grad-bar"></div>
        <div style="display:flex; justify-content:space-between; color:#888">
            <span>Baixa %</span>
            <span>Alta %</span>
        </div>
    </div>
</div>

<script>
    // --- 1. SETUP ---
    const years = [2022, 2018];
    const yearSel = document.getElementById('yearSelect');
    years.forEach(y => yearSel.add(new Option(y, y)));

    const partyColors = {
        'PT':'#ef4444', 'PL':'#1d4ed8', 'PSB':'#ef4444', 'PDT':'#f97316', 'UNI√ÉO':'#2563eb', 
        'PSDB':'#1e40af', 'MDB':'#16a34a', 'PSD':'#f59e0b', 'PP':'#0ea5e9', 'NOVO':'#f97316',
        'REPUBLICANOS':'#0ea5e9', 'SOLIDARIEDADE':'#f97316', 'DEFAULT':'#64748b'
    };

    const ufIds = {'RO':11,'AC':12,'AM':13,'RR':14,'PA':15,'AP':16,'TO':17,'MA':21,'PI':22,'CE':23,'RN':24,'PB':25,'PE':26,'AL':27,'SE':28,'BA':29,'MG':31,'ES':32,'RJ':33,'SP':35,'PR':41,'SC':42,'RS':43,'MS':50,'MT':51,'GO':52,'DF':53};

    const map = L.map('map', { center:[-15.7, -47.8], zoom:4, zoomControl:false, background:'#0f1115' });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

    let fullData = null;    // JSON completo carregado
    let currentTurnData = null; // Dados apenas do turno selecionado
    let activeCandidates = new Set();
    let layers = { brazil: null, cities: null };
    let viewMode = 'BRASIL';

    // --- 2. HELPERS ---
    function normalizeName(str) {
        if(!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
    }

    function getStats(key, type) {
        if (!currentTurnData || !currentTurnData[type]) return null;
        const votesObj = currentTurnData[type][key];
        if (!votesObj) return null;

        let max = -1, winner = null, totalActive = 0, ranking = [];
        
        Object.entries(votesObj).forEach(([cand, votes]) => {
            if(activeCandidates.has(cand)) {
                totalActive += votes;
                if(votes > max) { max = votes; winner = cand; }
                ranking.push({cand, votes});
            }
        });
        
        if(!winner) return null;
        ranking.sort((a,b)=>b.votes - a.votes);

        return { 
            winner, 
            pct: (max/totalActive)*100, 
            votes: max, 
            total: totalActive,
            party: winner.match(/\((.*?)\)/)?.[1] || 'DEFAULT',
            ranking: ranking.slice(0,4)
        };
    }

    // --- 3. CORE LOGIC ---
    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const role = document.getElementById('roleSelect').value;
        const turn = document.getElementById('turnSelect').value;
        document.getElementById('loader').classList.remove('hidden');

        try {
            // Carrega arquivo apenas se mudou ano ou cargo
            const fileName = `data/${year}_${role}.json`;
            const res = await fetch(fileName);
            if(!res.ok) throw new Error("Arquivo de dados n√£o encontrado.");
            
            fullData = await res.json();
            
            // Seleciona o turno
            if (!fullData[turn]) {
                alert(`N√£o h√° dados para o ${turn}¬∫ turno nesta elei√ß√£o.`);
                currentTurnData = null;
            } else {
                currentTurnData = fullData[turn];
                setupSidebar();
                
                if(viewMode === 'BRASIL') {
                    if(layers.brazil) layers.brazil.setStyle(style);
                } else {
                    resetMap(); 
                }
            }

        } catch(e) {
            console.error(e);
            alert("Erro ao carregar dados. Verifique o console.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function setupSidebar() {
        const list = document.getElementById('candList');
        list.innerHTML = '';
        activeCandidates.clear();

        // Totais Nacionais
        let national = {};
        Object.values(currentTurnData.estados).forEach(uf => {
            Object.entries(uf).forEach(([c,v]) => national[c] = (national[c]||0)+v);
        });

        // Ordenar e Renderizar
        const sorted = Object.entries(national).sort((a,b) => b[1] - a[1]);
        const grandTotal = sorted.reduce((acc, curr) => acc + curr[1], 0);

        sorted.forEach(([cand, votes]) => {
            activeCandidates.add(cand);
            const party = cand.match(/\((.*?)\)/)?.[1] || 'DEFAULT';
            const pct = ((votes/grandTotal)*100).toFixed(2);
            
            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <input type="checkbox" checked onchange="toggleCand('${cand}')">
                <div class="cand-info">
                    <div class="cand-header">
                        <span style="color:${partyColors[party]||'#fff'}">${cand}</span>
                        <span>${pct}%</span>
                    </div>
                    <div class="cand-sub">
                        <span>${votes.toLocaleString('pt-BR')} votos</span>
                        <span>Total</span>
                    </div>
                    <div class="prog-bar"><div class="prog-fill" style="width:${pct}%; background:${partyColors[party]||'#fff'}"></div></div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleCand(c) {
        if(activeCandidates.has(c)) activeCandidates.delete(c); else activeCandidates.add(c);
        if(layers.brazil) layers.brazil.setStyle(style);
        if(layers.cities) layers.cities.setStyle(style);
    }

    // --- 4. MAPA ---
    function style(feature) {
        let key, type;
        if (viewMode === 'BRASIL') {
            key = String(feature.properties.id);
            type = 'estados';
        } else {
            key = normalizeName(feature.properties.name || feature.properties.nome);
            type = 'municipios';
        }

        const stats = getStats(key, type);
        if(!stats) return { fillColor: '#1a1a1a', weight:1, color:'#333', fillOpacity:0.6 };

        const color = partyColors[stats.party] || partyColors['DEFAULT'];
        let op = (stats.pct - 30) / 40; // 30% a 70%
        op = Math.max(0.3, Math.min(1, 0.3 + op));

        return { fillColor: color, weight: viewMode==='BRASIL'?1:0.5, color: '#000', fillOpacity: op };
    }

    function onEachFeature(feature, layer) {
        layer.on('click', () => {
            if(viewMode === 'BRASIL') loadCities(feature.properties.id);
        });
        
        layer.bindTooltip(() => {
            let key = viewMode==='BRASIL' ? String(feature.properties.id) : normalizeName(feature.properties.name || feature.properties.nome);
            let type = viewMode==='BRASIL' ? 'estados' : 'municipios';
            const s = getStats(key, type);
            const name = feature.properties.name || feature.properties.nome;
            
            if(!s) return `<b>${name}</b><br>Sem dados`;
            
            let rows = s.ranking.map(r => `
                <div class="tt-row">
                    <span>${r.cand}</span>
                    <span><b>${((r.votes/s.total)*100).toFixed(1)}%</b></span>
                </div>
            `).join('');
            
            return `<div class="leaflet-tooltip-own">
                <div class="tt-head">${name}</div>
                <div class="tt-body">${rows}</div>
            </div>`;
        }, { sticky: true, className: 'leaflet-tooltip-own', opacity: 1 });
    }

    // --- 5. IBGE API (V3 + Tratamento de Texto) ---
    async function loadCities(ufId) {
        document.getElementById('loader').classList.remove('hidden');
        // Usando a API V3 que √© mais permissiva
        const url = `https://servicodados.ibge.gov.br/api/v3/malhas/estados/${ufId}/municipios?qualidade=minima&formato=application/vnd.geo+json`;
        
        try {
            const res = await fetch(url);
            if(!res.ok) throw new Error("Erro na API do IBGE");
            
            // Importante: Ler como texto primeiro para evitar SyntaxError se vier HTML
            const text = await res.text();
            let geo;
            try {
                geo = JSON.parse(text);
            } catch(e) {
                throw new Error("IBGE retornou dados inv√°lidos.");
            }

            if(layers.brazil) map.removeLayer(layers.brazil);
            viewMode = 'MUNICIPIOS';
            layers.cities = L.geoJson(geo, { style: style, onEachFeature: onEachFeature }).addTo(map);
            map.fitBounds(layers.cities.getBounds());
            document.getElementById('backBtn').style.display = 'block';

        } catch(e) {
            console.error(e);
            alert("N√£o foi poss√≠vel carregar a malha municipal. O servi√ßo do IBGE pode estar inst√°vel.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function resetMap() {
        if(layers.cities) map.removeLayer(layers.cities);
        if(layers.brazil) {
            layers.brazil.addTo(map);
            layers.brazil.setStyle(style);
        } else {
            loadBrazilBase();
        }
        map.setView([-15.7, -47.8], 4);
        viewMode = 'BRASIL';
        document.getElementById('backBtn').style.display = 'none';
    }

    function loadBrazilBase() {
        fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
        .then(r=>r.json())
        .then(d=>{
            d.features.forEach(f=>f.properties.id=ufIds[f.properties.sigla]);
            layers.brazil = L.geoJson(d, {style:style, onEachFeature:onEachFeature}).addTo(map);
            document.getElementById('loader').classList.add('hidden');
        });
    }
    
    loadBrazilBase();
</script>
</body>
</html>
