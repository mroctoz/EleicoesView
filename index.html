<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Eleitoral Pro</title>
    
    <!-- Leaflet & Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- TEMA ESCURO PROFISSIONAL --- */
        :root {
            --bg-map: #0f1115;
            --panel-bg: rgba(20, 24, 30, 0.95);
            --border: 1px solid rgba(255,255,255,0.08);
            --accent: #3b82f6;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
        }

        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg-map); color: var(--text-main); overflow: hidden; }
        
        #app { width: 100vw; height: 100vh; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; background: var(--bg-map); }

        /* --- SIDEBAR --- */
        .sidebar {
            position: absolute; top: 20px; left: 20px; width: 360px; bottom: 20px;
            background: var(--panel-bg); backdrop-filter: blur(12px);
            border: var(--border); border-radius: 12px; z-index: 1000;
            display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }

        .header { padding: 24px; border-bottom: var(--border); }
        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .header p { margin: 5px 0 0; font-size: 0.85rem; color: var(--text-muted); }

        .controls { padding: 20px; display: grid; gap: 12px; border-bottom: var(--border); }
        select, .btn-action {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            border-radius: 6px; font-size: 0.9rem; cursor: pointer; outline: none;
            transition: all 0.2s;
        }
        select:hover { border-color: var(--accent); }
        .btn-action { background: var(--accent); border: none; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-action:hover { filter: brightness(1.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        /* Lista de Candidatos */
        .ranking-container { flex: 1; overflow-y: auto; padding: 0; }
        .cand-row {
            padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex; align-items: flex-start; gap: 12px;
            transition: background 0.2s;
        }
        .cand-row:hover { background: rgba(255,255,255,0.02); }
        
        .check-wrapper input { cursor: pointer; transform: scale(1.2); accent-color: var(--accent); margin-top: 4px; }
        
        .cand-info { flex: 1; }
        .cand-header { display: flex; justify-content: space-between; align-items: baseline; }
        .cand-name { font-weight: 600; font-size: 0.95rem; }
        .cand-percent { font-weight: 700; font-size: 1rem; }
        
        .cand-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        
        .progress-track { height: 4px; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- TOOLTIP AVANÇADO --- */
        .custom-tooltip {
            background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            font-family: 'Roboto', sans-serif; min-width: 220px; overflow: hidden;
        }
        .tooltip-title {
            background: rgba(255,255,255,0.05); padding: 10px 15px;
            font-weight: 700; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #fff; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tooltip-table { width: 100%; border-collapse: collapse; }
        .tooltip-row td { padding: 6px 15px; font-size: 0.85rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tooltip-row:last-child td { border-bottom: none; }
        .tt-cand { color: #fff; font-weight: 500; }
        .tt-val { text-align: right; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Botão Voltar */
        .back-btn {
            position: absolute; top: 25px; left: 400px; z-index: 1000;
            background: var(--panel-bg); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 20px; border-radius: 30px; cursor: pointer;
            font-weight: 600; display: none; align-items: center; gap: 8px;
            backdrop-filter: blur(5px); transition: all 0.2s;
        }
        .back-btn:hover { background: var(--accent); border-color: var(--accent); }

        /* Legenda */
        .legend {
            position: absolute; bottom: 25px; right: 25px;
            background: var(--panel-bg); padding: 15px; border-radius: 8px;
            border: var(--border); width: 200px; font-size: 0.75rem; z-index: 999;
        }
        .grad-bar { height: 10px; background: linear-gradient(90deg, #222 0%, #fff 100%); margin: 8px 0; border-radius: 5px; border: 1px solid #444; }
        
        /* Loader */
        #loader {
            position: absolute; inset: 0; background: #0b0f19; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s;
        }
        .hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; color:#888; letter-spacing:1px;">CARREGANDO DADOS...</p>
</div>

<div id="app">
    <button class="back-btn" id="backBtn" onclick="resetMap()">
        <i class="fas fa-arrow-left"></i> Voltar para Visão Nacional
    </button>
    
    <aside class="sidebar">
        <div class="header">
            <h1><i class="fas fa-chart-pie" style="color:var(--accent)"></i> Atlas Eleitoral</h1>
            <p>Visualizador Geoespacial de Votos (1994-2022)</p>
        </div>
        
        <div class="controls">
            <div style="display:flex; gap:10px;">
                <select id="yearSelect"></select>
                <select id="roleSelect">
                    <option value="president">Presidente</option>
                    <option value="governor">Governador</option>
                    <option value="senator">Senador</option>
                </select>
            </div>
            <button class="btn-action" onclick="loadData()">
                <i class="fas fa-sync-alt"></i> Atualizar Mapa
            </button>
        </div>

        <div class="ranking-container" id="candList">
            <div style="padding:40px 20px; text-align:center; color:#555;">
                <i class="fas fa-arrow-up"></i><br><br>Selecione um ano e cargo acima para carregar os dados.
            </div>
        </div>
    </aside>

    <main id="map"></main>

    <div class="legend">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:bold;">
            <span>Intensidade</span>
        </div>
        <div class="grad-bar"></div>
        <div style="display:flex; justify-content:space-between; color:#888;">
            <span>Baixa %<br>(Transparente)</span>
            <span>Alta %<br>(Sólido)</span>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURAÇÕES GERAIS ---
    const years = [2022, 2018, 2014, 2010]; 
    const yearSel = document.getElementById('yearSelect');
    years.forEach(y => { let o = document.createElement('option'); o.value=y; o.text=y; yearSel.add(o); });

    // Cores (Hex Codes)
    const partyColors = {
        'PT':'#ef4444', 'PCdoB':'#b91c1c', 'PSB':'#ef4444', 'PDT':'#f97316', 'PSOL':'#fcd34d', 'REDE':'#10b981',
        'PL':'#1d4ed8', 'PP':'#0ea5e9', 'REP':'#0ea5e9', 'UNIÃO':'#2563eb', 'PSDB':'#1e40af', 'DEM':'#1e40af',
        'MDB':'#16a34a', 'PMDB':'#16a34a', 'PSD':'#f59e0b', 'NOVO':'#f97316', 'SOLIDARIEDADE':'#f97316',
        'DEFAULT':'#64748b'
    };

    // Códigos IBGE Estados
    const ufIds = {'RO':11,'AC':12,'AM':13,'RR':14,'PA':15,'AP':16,'TO':17,'MA':21,'PI':22,'CE':23,'RN':24,'PB':25,'PE':26,'AL':27,'SE':28,'BA':29,'MG':31,'ES':32,'RJ':33,'SP':35,'PR':41,'SC':42,'RS':43,'MS':50,'MT':51,'GO':52,'DF':53};

    // --- 2. INICIALIZAÇÃO DO MAPA ---
    const map = L.map('map', { 
        center: [-15.7, -47.8], 
        zoom: 4, 
        zoomControl: false, 
        attributionControl: false,
        background: '#0f1115'
    });
    
    L.control.zoom({ position: 'topright' }).addTo(map);
    
    // Camada Base (Sem labels, escura)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);

    // Estado da Aplicação
    let currentData = null;
    let activeCandidates = new Set();
    let layers = { brazil: null, cities: null };
    let viewMode = 'BRASIL'; // 'BRASIL' ou 'MUNICIPIOS'

    // --- 3. FUNÇÕES DE UTILIDADE ---
    
    // Normalização de nomes (Remove acentos e espaços extras para "bater" com o JSON)
    function normalizeName(str) {
        if(!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
    }

    // Calcula % e Vencedor para um local
    function getStats(key, type) {
        if (!currentData || !currentData[type]) return null;
        
        const votesObj = currentData[type][key];
        if (!votesObj) return null;

        let max = -1, winner = null, totalActive = 0, ranking = [];
        
        Object.entries(votesObj).forEach(([cand, votes]) => {
            if(activeCandidates.has(cand)) {
                totalActive += votes;
                if(votes > max) { max = votes; winner = cand; }
                ranking.push({ cand, votes });
            }
        });

        // Ordena para o Tooltip
        ranking.sort((a,b) => b.votes - a.votes);

        if(!winner) return null;

        return { 
            winner, 
            pct: (max/totalActive)*100, 
            votes: max,
            total: totalActive,
            party: winner.match(/\((.*?)\)/)?.[1] || 'DEFAULT',
            ranking: ranking.slice(0, 4) // Top 4 para o Tooltip
        };
    }

    // --- 4. CARREGAMENTO DE DADOS ---

    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const role = document.getElementById('roleSelect').value;
        const loader = document.getElementById('loader');
        
        loader.classList.remove('hidden');

        try {
            // Tenta carregar o JSON gerado
            const res = await fetch(`data/${year}_${role}.json`);
            if(!res.ok) throw new Error("Dados não encontrados para esta seleção.");
            
            currentData = await res.json();
            
            setupSidebar();
            
            if(viewMode === 'BRASIL') {
                if(layers.brazil) layers.brazil.setStyle(style);
            } else {
                resetMap(); // Se mudar de dados estando numa cidade, volta pro Brasil
            }

        } catch(e) {
            console.error(e);
            alert("Erro: Arquivo de dados não encontrado. Verifique a pasta 'data'.");
        } finally {
            loader.classList.add('hidden');
        }
    }

    // Gera a Sidebar com Estatísticas Nacionais
    function setupSidebar() {
        const list = document.getElementById('candList');
        list.innerHTML = '';
        activeCandidates.clear();

        // 1. Calcular Totais Nacionais (Agregando todos os estados)
        let nationalTotals = {};
        Object.values(currentData.estados).forEach(ufVotes => {
            Object.entries(ufVotes).forEach(([cand, votes]) => {
                nationalTotals[cand] = (nationalTotals[cand] || 0) + votes;
            });
        });

        const sorted = Object.entries(nationalTotals).sort((a,b) => b[1] - a[1]);
        const grandTotal = sorted.reduce((acc, curr) => acc + curr[1], 0);

        // 2. Criar HTML
        sorted.forEach(([cand, votes]) => {
            activeCandidates.add(cand);
            
            const party = cand.match(/\((.*?)\)/)?.[1] || 'DEFAULT';
            const color = partyColors[party] || partyColors['DEFAULT'];
            const pct = ((votes / grandTotal) * 100).toFixed(2);

            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <div class="check-wrapper">
                    <input type="checkbox" checked onchange="toggleCand('${cand}')">
                </div>
                <div class="cand-info">
                    <div class="cand-header">
                        <span class="cand-name" style="color:${color}">${cand}</span>
                        <span class="cand-percent">${pct}%</span>
                    </div>
                    <div class="cand-meta">
                        <span>${votes.toLocaleString('pt-BR')} votos</span>
                        <span>Total</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width:${pct}%; background:${color}"></div>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleCand(c) {
        if(activeCandidates.has(c)) activeCandidates.delete(c); else activeCandidates.add(c);
        
        // Atualiza estilos sem recarregar tudo
        if(layers.brazil) layers.brazil.setStyle(style);
        if(layers.cities) layers.cities.setStyle(style);
    }

    // --- 5. RENDERIZAÇÃO E ESTILOS ---

    function style(feature) {
        let key, type;
        
        if (viewMode === 'BRASIL') {
            key = String(feature.properties.id); // ID IBGE do Estado
            type = 'estados';
        } else {
            key = normalizeName(feature.properties.name || feature.properties.nome); // Nome da Cidade
            type = 'municipios';
        }

        const res = getStats(key, type);

        if(!res) {
            // Sem dados: Cinza muito escuro
            return { fillColor: '#1a1a1a', weight: 1, color: '#333', fillOpacity: 0.6 };
        }

        const color = partyColors[res.party] || partyColors['DEFAULT'];
        
        // --- LÓGICA DE DEGRADÊ CORRIGIDA ---
        // Mais % = Mais Opaco (Sólido/Brilhante)
        // Menos % = Mais Transparente (Escuro/Fundo)
        // Escala: 30% a 70% vira opacidade 0.3 a 0.9
        let op = (res.pct - 30) / 40;
        op = Math.max(0.3, Math.min(1.0, 0.3 + op));

        return { 
            fillColor: color, 
            weight: viewMode==='BRASIL'?1:0.5, 
            color: '#000', 
            fillOpacity: op 
        };
    }

    // Gera o Tooltip com Top 4
    function getTooltipContent(feature) {
        let key = viewMode==='BRASIL' ? String(feature.properties.id) : normalizeName(feature.properties.name || feature.properties.nome);
        let type = viewMode==='BRASIL' ? 'estados' : 'municipios';
        let name = feature.properties.name || feature.properties.nome;
        
        const res = getStats(key, type);
        
        if(!res) return `<div style="padding:10px;"><b>${name}</b><br>Sem dados neste cenário</div>`;

        let rows = res.ranking.map(r => {
            const p = r.cand.match(/\((.*?)\)/)?.[1];
            const cColor = partyColors[p] || '#fff';
            const pct = ((r.votes / res.total) * 100).toFixed(1);
            return `
                <tr class="tooltip-row">
                    <td><span style="color:${cColor}">●</span> ${r.cand}</td>
                    <td class="tt-val"><b>${pct}%</b></td>
                    <td class="tt-val" style="color:#888">${(r.votes/1000).toFixed(1)}k</td>
                </tr>
            `;
        }).join('');

        return `
            <div class="custom-tooltip">
                <div class="tooltip-title">${name}</div>
                <table class="tooltip-table">
                    ${rows}
                </table>
            </div>
        `;
    }

    function onEachFeature(feature, layer) {
        // Evento de Clique (Drill Down)
        layer.on('click', () => {
            if(viewMode === 'BRASIL') {
                const ufId = feature.properties.id;
                loadCities(ufId);
            }
        });

        // Tooltip
        layer.bindTooltip(() => getTooltipContent(feature), {
            sticky: true,
            direction: 'top',
            offset: [0, -10],
            opacity: 1,
            className: 'leaflet-tooltip-own' // remove estilos padrão se necessário
        });
    }

    // --- 6. API IBGE (CORRIGIDA E ROBUSTA) ---

    async function loadCities(ufId) {
        document.getElementById('loader').classList.remove('hidden');
        
        // URL da API V3 (Mais estável que V4)
        // quality=minima reduz o tamanho do arquivo drasticamente
        const url = `https://servicodados.ibge.gov.br/api/v3/malhas/estados/${ufId}/municipios?qualidade=minima&formato=application/vnd.geo+json`;
        
        try {
            const res = await fetch(url);
            
            if (!res.ok) {
                if(res.status === 404) throw new Error("IBGE: Estado não encontrado ou serviço indisponível.");
                throw new Error(`Erro API IBGE: ${res.status}`);
            }

            const geo = await res.json();

            // Troca Camadas
            if(layers.brazil) map.removeLayer(layers.brazil);
            
            viewMode = 'MUNICIPIOS';
            layers.cities = L.geoJson(geo, { style: style, onEachFeature: onEachFeature }).addTo(map);
            
            map.fitBounds(layers.cities.getBounds());
            document.getElementById('backBtn').style.display = 'flex';

        } catch(e) {
            console.error(e);
            alert(`Falha ao carregar malha municipal: ${e.message}\nTente novamente em alguns instantes.`);
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function resetMap() {
        if(layers.cities) map.removeLayer(layers.cities);
        
        if(layers.brazil) {
            layers.brazil.addTo(map);
            layers.brazil.setStyle(style); // Reaplica estilo
        } else {
            loadBrazilMap();
        }
        
        map.setView([-15.7, -47.8], 4);
        viewMode = 'BRASIL';
        document.getElementById('backBtn').style.display = 'none';
    }

    // Carregamento Inicial do Brasil
    function loadBrazilMap() {
        // IDs IBGE
        fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
        .then(r => r.json())
        .then(d => {
            d.features.forEach(f => f.properties.id = ufIds[f.properties.sigla]);
            layers.brazil = L.geoJson(d, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            document.getElementById('loader').classList.add('hidden');
        });
    }

    // Início
    loadBrazilMap();

</script>
</body>
</html>
