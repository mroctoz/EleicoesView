<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Eleitoral 3.0</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --bg: #111; --panel: rgba(20,20,20,0.9); --accent: #2563eb; --text: #eee; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        #app { width: 100vw; height: 100vh; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; background: #0b0f19; }

        /* Painel Flutuante */
        .sidebar {
            position: absolute; top: 20px; left: 20px; width: 320px; bottom: 20px;
            background: var(--panel); backdrop-filter: blur(10px);
            border: 1px solid #333; border-radius: 12px; z-index: 1000;
            display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .header { padding: 20px; border-bottom: 1px solid #333; }
        .controls { padding: 15px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
        select, button { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; cursor: pointer; }
        button { background: var(--accent); border: none; font-weight: bold; }
        button:hover { filter: brightness(1.1); }
        
        .list-container { flex: 1; overflow-y: auto; padding: 0; }
        .cand-row { padding: 10px 15px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
        .cand-row:hover { background: #222; }
        
        /* Legenda */
        .legend { position: absolute; bottom: 20px; right: 20px; background: var(--panel); padding: 10px; border-radius: 8px; z-index: 999; width: 180px; font-size: 0.75rem; border: 1px solid #333; }
        .grad-bar { height: 8px; background: linear-gradient(90deg, #333, #fff); margin: 5px 0; }
        
        .back-btn { position: absolute; top: 20px; left: 360px; z-index: 1000; display: none; padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        #loader { position: absolute; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.5s; }
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="loader"><i class="fas fa-circle-notch fa-spin fa-2x"></i><p style="margin-top:10px">Carregando...</p></div>

<div id="app">
    <button class="back-btn" id="backBtn" onclick="resetMap()"><i class="fas fa-arrow-left"></i> Voltar para Brasil</button>
    
    <aside class="sidebar">
        <div class="header">
            <h1 style="margin:0; font-size:1.2rem;">üó≥Ô∏è Elei√ß√µes Brasil</h1>
            <small style="color:#888">Visualiza√ß√£o Detalhada</small>
        </div>
        <div class="controls">
            <select id="yearSelect"></select>
            <select id="roleSelect">
                <option value="president">Presidente</option>
                <option value="governor">Governador</option>
                <option value="senator">Senador</option>
            </select>
            <button onclick="loadData()">CARREGAR DADOS</button>
        </div>
        <div class="list-container" id="candList">
            <div style="padding:20px; text-align:center; color:#666">Selecione e carregue.</div>
        </div>
    </aside>

    <main id="map"></main>

    <div class="legend">
        <b>Intensidade do Vencedor</b>
        <div class="grad-bar"></div>
        <div style="display:flex; justify-content:space-between; color:#888">
            <span>+ Disputado</span>
            <span>+ Vit√≥ria</span>
        </div>
    </div>
</div>

<script>
    // --- SETUP ---
    const years = [2022, 2018];
    const yearSel = document.getElementById('yearSelect');
    years.forEach(y => { let o = document.createElement('option'); o.value=y; o.text=y; yearSel.add(o); });

    const partyColors = {
        'PT':'#ef4444', 'PL':'#1d4ed8', 'PSB':'#ef4444', 'PDT':'#f97316', 
        'UNI√ÉO':'#2563eb', 'PSDB':'#1e40af', 'MDB':'#16a34a', 'PSD':'#f59e0b', 
        'PP':'#0ea5e9', 'NOVO':'#f97316', 'DEFAULT':'#64748b'
    };

    const map = L.map('map', { center: [-15.7, -47.8], zoom: 4, zoomControl: false, background:'#0b0f19' });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

    let currentData = null;
    let activeCandidates = new Set();
    let layers = { brazil: null, cities: null };
    let viewMode = 'BRASIL';

    // --- FUN√á√ïES √öTEIS ---
    
    // Normaliza nome para bater com o JSON (remove acentos)
    function normalizeName(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    }

    // Calcula vencedor baseado nos checkboxes
    function getWinner(key, type) {
        // type = 'estados' (key=ID IBGE) ou 'municipios' (key=NOME)
        if (!currentData || !currentData[type]) return null;
        
        const votesObj = currentData[type][key];
        if (!votesObj) return null; // N√£o achou a cidade/estado

        let max = -1, winner = null, totalActive = 0;
        
        Object.entries(votesObj).forEach(([cand, votes]) => {
            if(activeCandidates.has(cand)) {
                totalActive += votes;
                if(votes > max) { max = votes; winner = cand; }
            }
        });

        if(!winner) return null;
        return { 
            winner, 
            pct: (max/totalActive)*100, 
            party: winner.match(/\((.*?)\)/)?.[1] || 'DEFAULT',
            votes: max 
        };
    }

    // --- RENDERIZA√á√ÉO ---

    function style(feature) {
        let result;
        if (viewMode === 'BRASIL') {
            // Usa ID do IBGE (propriedade 'id' do GeoJSON)
            result = getWinner(String(feature.properties.id), 'estados');
        } else {
            // Usa NOME da Cidade normalizado
            const name = normalizeName(feature.properties.nome || feature.properties.name);
            result = getWinner(name, 'municipios');
        }

        if(!result) return { fillColor: '#1a1a1a', weight: 1, color: '#333', fillOpacity: 0.5 };

        const color = partyColors[result.party] || partyColors['DEFAULT'];
        let op = (result.pct - 30) / 60; // Gradiente
        op = Math.max(0.3, Math.min(1, 0.2 + op));

        return { fillColor: color, weight: viewMode==='BRASIL'?1:0.5, color: '#000', fillOpacity: op };
    }

    function onEachFeature(feature, layer) {
        layer.on('click', async () => {
            if(viewMode === 'BRASIL') {
                // Entrar no Estado
                const ufId = feature.properties.id;
                await loadCities(ufId);
            }
        });

        layer.bindPopup(() => {
            let key = viewMode==='BRASIL' ? String(feature.properties.id) : normalizeName(feature.properties.nome);
            let type = viewMode==='BRASIL' ? 'estados' : 'municipios';
            let res = getWinner(key, type);
            let name = feature.properties.name || feature.properties.nome;
            
            if(!res) return `<b>${name}</b><br>Sem dados`;
            return `<b>${name}</b><br><b style="color:${partyColors[res.party]}">${res.winner}</b><br>${res.pct.toFixed(1)}% (${res.votes.toLocaleString()} votos)`;
        });
    }

    // --- CARREGAMENTO ---

    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const role = document.getElementById('roleSelect').value;
        document.getElementById('loader').classList.remove('hidden');

        try {
            const r = await fetch(`data/${year}_${role}.json`);
            if(!r.ok) throw new Error();
            currentData = await r.json();
            
            setupSidebar();
            if(viewMode === 'BRASIL') refreshMap();
            else resetMap(); // Volta pro Brasil se mudar dados estando na cidade

        } catch(e) {
            alert("Dados n√£o encontrados. Verifique a pasta 'data'.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function setupSidebar() {
        const list = document.getElementById('candList');
        list.innerHTML = '';
        activeCandidates.clear();

        // Agrega votos totais para a sidebar
        let totals = {};
        Object.values(currentData.estados).forEach(uf => {
            Object.entries(uf).forEach(([c,v]) => totals[c] = (totals[c]||0)+v);
        });

        Object.entries(totals).sort((a,b)=>b[1]-a[1]).forEach(([cand, votes]) => {
            activeCandidates.add(cand);
            const party = cand.match(/\((.*?)\)/)?.[1];
            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <input type="checkbox" checked onchange="toggleCand('${cand}')">
                <div style="width:10px;height:10px;border-radius:50%;background:${partyColors[party]||'#888'}"></div>
                <div><b>${cand}</b><br><span style="color:#888">${votes.toLocaleString()} votos</span></div>
            `;
            list.appendChild(div);
        });
    }

    function toggleCand(c) {
        if(activeCandidates.has(c)) activeCandidates.delete(c);
        else activeCandidates.add(c);
        if(layers.brazil) layers.brazil.setStyle(style);
        if(layers.cities) layers.cities.setStyle(style);
    }

    // --- L√ìGICA DE NAVEGA√á√ÉO ---

    async function loadCities(ufId) {
        document.getElementById('loader').classList.remove('hidden');
        try {
            const res = await fetch(`https://servicodados.ibge.gov.br/api/v3/malhas/estados/${ufId}/municipios?qualidade=minima&formato=application/vnd.geo+json`);
            const geo = await res.json();

            if(layers.brazil) map.removeLayer(layers.brazil);
            
            viewMode = 'CITIES';
            layers.cities = L.geoJson(geo, { style: style, onEachFeature: onEachFeature }).addTo(map);
            map.fitBounds(layers.cities.getBounds());
            document.getElementById('backBtn').style.display = 'block';

        } catch(e) { console.error(e); }
        finally { document.getElementById('loader').classList.add('hidden'); }
    }

    function resetMap() {
        if(layers.cities) map.removeLayer(layers.cities);
        if(layers.brazil) layers.brazil.addTo(map);
        else loadBrazil(); // Recarrega se sumiu
        
        map.setView([-15.7, -47.8], 4);
        viewMode = 'BRASIL';
        document.getElementById('backBtn').style.display = 'none';
    }

    function refreshMap() {
        if(layers.brazil) layers.brazil.setStyle(style);
    }

    // Load inicial
    function loadBrazil() {
        const ufIds = {'RO':11,'AC':12,'AM':13,'RR':14,'PA':15,'AP':16,'TO':17,'MA':21,'PI':22,'CE':23,'RN':24,'PB':25,'PE':26,'AL':27,'SE':28,'BA':29,'MG':31,'ES':32,'RJ':33,'SP':35,'PR':41,'SC':42,'RS':43,'MS':50,'MT':51,'GO':52,'DF':53};
        fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
        .then(r=>r.json())
        .then(d=>{
            d.features.forEach(f=>f.properties.id=ufIds[f.properties.sigla]);
            layers.brazil = L.geoJson(d, {style:style, onEachFeature:onEachFeature}).addTo(map);
            document.getElementById('loader').classList.add('hidden');
        });
    }
    
    loadBrazil();

</script>
</body>
</html>
