<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Atlas Eleitoral V8 - Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{--bg:#0f1115;--panel:rgba(20,24,30,0.95);--accent:#3b82f6;--text:#fff}
        body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
        #app{width:100vw;height:100vh;position:relative}
        #map{width:100%;height:100%;background:var(--bg);z-index:1}
        
        /* UI */
        .sidebar{position:absolute;top:20px;left:20px;width:340px;bottom:20px;background:var(--panel);backdrop-filter:blur(10px);border:1px solid #333;border-radius:12px;z-index:1000;display:flex;flex-direction:column}
        .header,.controls{padding:20px;border-bottom:1px solid #333}
        .cand-list{flex:1;overflow-y:auto}
        select,.btn{width:100%;padding:10px;background:#222;border:1px solid #444;color:#fff;border-radius:6px;margin-bottom:8px}
        .btn{background:var(--accent);border:none;font-weight:700;cursor:pointer}
        .cand-row{padding:12px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center}
        .cand-row:hover{background:#222}
        
        /* Loading */
        #loader{position:absolute;inset:0;background:var(--bg);z-index:2000;display:flex;justify-content:center;align-items:center;flex-direction:column;transition:opacity 0.3s}
        .hidden{opacity:0;pointer-events:none}
        .back-btn{position:absolute;top:20px;left:380px;z-index:1000;background:var(--panel);color:#fff;border:1px solid #444;padding:8px 16px;border-radius:20px;cursor:pointer;display:none}
        
        /* Legend */
        .legend{position:absolute;bottom:30px;right:30px;background:var(--panel);padding:15px;border-radius:8px;z-index:999;border:1px solid #333;font-size:0.8rem}
        .grad{height:8px;background:linear-gradient(90deg,#222,#fff);margin:5px 0}
        
        /* Tooltip */
        .leaflet-tooltip-own{background:rgba(10,12,16,0.95)!important;border:1px solid #444!important;color:#fff!important;border-radius:6px!important}
    </style>
</head>
<body>

<div id="loader"><i class="fas fa-circle-notch fa-spin fa-2x"></i><p style="margin-top:10px">Carregando...</p></div>

<div id="app">
    <button class="back-btn" id="backBtn" onclick="resetToBrazil()">Voltar ao Brasil</button>
    
    <aside class="sidebar">
        <div class="header"><h1>üó≥Ô∏è Elei√ß√µes V8</h1></div>
        <div class="controls">
            <select id="yearSelect"></select>
            <select id="turnSelect"><option value="1">1¬∫ Turno</option><option value="2">2¬∫ Turno</option></select>
            <select id="roleSelect"><option value="president">Presidente</option><option value="governor">Governador</option><option value="senator">Senador</option></select>
            <button class="btn" onclick="loadData()">ATUALIZAR MAPA</button>
        </div>
        <div class="cand-list" id="candList"></div>
    </aside>

    <main id="map"></main>
    
    <div class="legend">
        <b>Intensidade</b><div class="grad"></div>
        <div style="display:flex;justify-content:space-between"><span>Baixa</span><span>Alta</span></div>
    </div>
</div>

<script>
    const CONFIG = {
        years: [2022, 2018],
        ufIds: {'RO':'11','AC':'12','AM':'13','RR':'14','PA':'15','AP':'16','TO':'17','MA':'21','PI':'22','CE':'23','RN':'24','PB':'25','PE':'26','AL':'27','SE':'28','BA':'29','MG':'31','ES':'32','RJ':'33','SP':'35','PR':'41','SC':'42','RS':'43','MS':'50','MT':'51','GO':'52','DF':'53'},
        colors: {'PT':'#ef4444','PL':'#1d4ed8','PSB':'#ef4444','PDT':'#f97316','UNI√ÉO':'#2563eb','PSDB':'#1e40af','MDB':'#16a34a','PSD':'#f59e0b','PP':'#0ea5e9','NOVO':'#f97316','DEFAULT':'#64748b'}
    };

    const map = L.map('map', { center:[-15.7,-47.8], zoom:4, zoomControl:false, background:'#0f1115' });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    
    let STATE = { fullData:null, currentTurn:null, active:new Set(), view:'BRASIL', layers:{brazil:null,cities:null} };

    // --- SETUP ---
    const ys = document.getElementById('yearSelect');
    CONFIG.years.forEach(y => ys.add(new Option(y,y)));
    
    // --- LOAD DATA ---
    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const role = document.getElementById('roleSelect').value;
        const turn = document.getElementById('turnSelect').value;
        
        document.getElementById('loader').classList.remove('hidden');
        try {
            const res = await fetch(`data/${year}_${role}.json`);
            if(!res.ok) throw new Error("Dados n√£o encontrados");
            STATE.fullData = await res.json();
            
            if(!STATE.fullData[turn]) { alert("Sem dados para este turno"); return; }
            STATE.currentTurn = STATE.fullData[turn];
            
            renderSidebar();
            if(STATE.view === 'BRASIL') updateLayer(STATE.layers.brazil);
            else updateLayer(STATE.layers.cities); // Reaplica cor nas cidades se j√° estiver l√°
            
        } catch(e) { alert(e.message); }
        finally { document.getElementById('loader').classList.add('hidden'); }
    }

    function renderSidebar() {
        const list = document.getElementById('candList');
        list.innerHTML = '';
        STATE.active.clear();
        
        // Agrega Nacional
        let total = {};
        Object.values(STATE.currentTurn.estados).forEach(uf => {
            Object.entries(uf).forEach(([c,v]) => total[c] = (total[c]||0)+v);
        });
        
        Object.entries(total).sort((a,b)=>b[1]-a[1]).forEach(([cand, votes]) => {
            STATE.active.add(cand);
            const party = cand.match(/\((.*?)\)/)?.[1]||'DEFAULT';
            const color = CONFIG.colors[party]||'#fff';
            
            const div = document.createElement('div');
            div.className = 'cand-row';
            div.innerHTML = `
                <input type="checkbox" checked onchange="toggle('${cand}')">
                <div style="width:10px;height:10px;background:${color};border-radius:50%"></div>
                <div><b>${cand}</b><br><span style="color:#888">${votes.toLocaleString()} votos</span></div>
            `;
            list.appendChild(div);
        });
    }

    function toggle(c) {
        if(STATE.active.has(c)) STATE.active.delete(c); else STATE.active.add(c);
        if(STATE.view==='BRASIL') updateLayer(STATE.layers.brazil);
        else updateLayer(STATE.layers.cities);
    }

    // --- MAP LOGIC ---
    function getStats(key, type) {
        // key deve ser ID (string)
        if(!STATE.currentTurn || !STATE.currentTurn[type]) return null;
        const obj = STATE.currentTurn[type][key];
        if(!obj) return null;

        let max=-1, win=null, tot=0;
        Object.entries(obj).forEach(([c,v]) => {
            if(STATE.active.has(c)) { tot+=v; if(v>max){max=v;win=c;} }
        });
        
        if(!win) return null;
        return { 
            winner:win, pct:(max/tot)*100, votes:max, 
            party:win.match(/\((.*?)\)/)?.[1]||'DEFAULT' 
        };
    }

    function style(feature) {
        let key = STATE.view==='BRASIL' ? String(feature.properties.id) : String(feature.properties.id || feature.properties.codarea);
        let type = STATE.view==='BRASIL' ? 'estados' : 'municipios';
        
        const s = getStats(key, type);
        if(!s) return { fillColor:'#222', weight:1, color:'#333', fillOpacity:0.5 };
        
        const color = CONFIG.colors[s.party] || '#888';
        const op = Math.max(0.3, Math.min(1, (s.pct-30)/50));
        return { fillColor:color, weight:STATE.view==='BRASIL'?1.5:0.5, color:'#000', fillOpacity:op };
    }

    function updateLayer(layer) {
        if(layer) layer.setStyle(style);
    }

    function onEachFeature(feature, layer) {
        layer.on('click', () => {
            if(STATE.view === 'BRASIL') loadCities(feature.properties.id);
        });
        
        layer.bindTooltip(() => {
            let key = STATE.view==='BRASIL' ? String(feature.properties.id) : String(feature.properties.id || feature.properties.codarea);
            let type = STATE.view==='BRASIL' ? 'estados' : 'municipios';
            const s = getStats(key, type);
            const name = feature.properties.name || feature.properties.nome;
            
            if(!s) return `<b>${name}</b><br>Sem dados`;
            return `<b>${name}</b><br>${s.winner}<br>${s.pct.toFixed(1)}%`;
        }, { sticky:true, className:'leaflet-tooltip-own' });
    }

    // --- CARREGAMENTO GEOGR√ÅFICO ROBUSTO ---
    async function loadCities(ufId) {
        document.getElementById('loader').classList.remove('hidden');
        
        // Tenta API IBGE Oficial
        let url = `https://servicodados.ibge.gov.br/api/v3/malhas/estados/${ufId}/municipios?qualidade=minima&formato=application/vnd.geo+json`;
        
        try {
            let res = await fetch(url);
            if(!res.ok) throw new Error("Falha IBGE");
            let geo = await res.json();
            
            // Garantir que properties tenha o ID correto (codarea)
            // Se IBGE mudar padr√£o, usamos fallback
            renderCities(geo);
            
        } catch(e) {
            console.warn("IBGE falhou, tentando Fallback est√°tico...", e);
            try {
                // Fallback: GeoJSONs est√°ticos do GitHub (tbrugz)
                let urlBackup = `https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-${ufId}-mun.json`;
                let resBackup = await fetch(urlBackup);
                let geoBackup = await resBackup.json();
                
                // Normaliza ID do backup (ele usa 'id' para c√≥digo ibge)
                geoBackup.features.forEach(f => {
                    // O arquivo do tbrugz tem ID curto (6 digitos) ou longo?
                    // Geralmente 7. Vamos garantir string.
                    if(f.properties.id) f.properties.codarea = String(f.properties.id);
                });
                
                renderCities(geoBackup);
            } catch(e2) {
                alert("Erro fatal: N√£o foi poss√≠vel carregar o mapa.");
                resetToBrazil();
            }
        } finally {
            document.getElementById('loader').classList.add('hidden');
        }
    }

    function renderCities(geo) {
        if(STATE.layers.brazil) map.removeLayer(STATE.layers.brazil);
        if(STATE.layers.cities) map.removeLayer(STATE.layers.cities);
        
        STATE.view = 'MUNICIPIOS';
        STATE.layers.cities = L.geoJson(geo, { style:style, onEachFeature:onEachFeature }).addTo(map);
        map.fitBounds(STATE.layers.cities.getBounds());
        document.getElementById('backBtn').style.display = 'block';
    }

    function resetToBrazil() {
        if(STATE.layers.cities) map.removeLayer(STATE.layers.cities);
        loadBrazilBase();
        STATE.view = 'BRASIL';
        map.setView([-15.7,-47.8], 4);
        document.getElementById('backBtn').style.display = 'none';
    }

    function loadBrazilBase() {
        if(STATE.layers.brazil && !map.hasLayer(STATE.layers.brazil)) {
            STATE.layers.brazil.addTo(map);
            updateLayer(STATE.layers.brazil);
            return;
        }
        
        fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson')
        .then(r=>r.json()).then(d=>{
            d.features.forEach(f=>f.properties.id=CONFIG.ufIds[f.properties.sigla]);
            STATE.layers.brazil = L.geoJson(d, {style:style, onEachFeature:onEachFeature}).addTo(map);
            document.getElementById('loader').classList.add('hidden');
        });
    }
    
    // In√≠cio
    loadBrazilBase();
</script>
</body>
</html>
